## 流量控制和可靠传输
![画板](https://cdn.nlark.com/yuque/0/2025/jpeg/48073730/1735894104572-84b1ee16-8f3d-4062-be60-800a9a77d9b9.jpeg)

思考一下为什么一定需要给帧进行编号呢？

**我们想象一个场景：如果发送方在发送了一个帧给接收方后，接收方的确认帧在传输给发送方的过程中丢失，此时接收方的滑动窗口已经准备接收新的帧了，但是发送方还没有接收到确认帧，在超时之后重传，然后接收方需要知道这个重传的帧到底是接收方想要的新的帧还是之前的帧，此时就需要帧的编号了。换句话说就是帧编号可以让接收方判断这个帧是不是重复帧。不是接收方想要的新的帧就一定是之前的重复帧。**

****

这个第 i 号帧并不是普通的增加就完了，而是一种循环，不然根本就没有那么多表示位数的 bit 位给它用。
例子：使用 S-W 协议（这里贴出图示下面就不再贴了）

将要发送的帧全部编号 0  1  0  1  0  1...，那么接收方要接受的帧也为 0  1  0  1  0  1...

这样就可以表示所有的帧了，因为需要接收方确认了之后发送方才能继续向后发送则肯定可以保证如果发生错误需要重传的是窗口中的哪一个帧。

这里有几个专业名词： 0  1  0  1  0  1...这个称为帧序号

![](https://cdn.nlark.com/yuque/0/2025/png/48073730/1735871919949-44425f9d-9a72-4f7f-9e4a-5eb2c280db7b.png)

## 滑动窗口机制
在发送方有个发送窗口，在接收方有个接收窗口。发送方一次只能传输发送窗口内的帧，接收方只能接收接收窗口大小的帧，如果发送窗口的帧多于接收窗口的帧则多余的帧直接丢弃。在接收方接收完成后就会使用确认机制向发送方说可以继续了，发送方的滑动窗口就向后滑动和接收方滑动窗口同样大小的帧。按照这种模式依次发送

## 停止等待协议
![画板](https://cdn.nlark.com/yuque/0/2025/jpeg/48073730/1735892638300-1bcc03b9-df38-44cc-97f9-281c0c631434.jpeg)

S-W 协议中不存在数据帧失序的问题，因为帧是一个一个的发送和接收的。其余的操作和上面的一致

## 后退 N 帧协议
![画板](https://cdn.nlark.com/yuque/0/2025/jpeg/48073730/1740216116076-c5105509-7ce6-4f75-8883-e156143e37d5.jpeg)

![](https://cdn.nlark.com/yuque/0/2025/png/48073730/1735894343428-20a67220-09d7-47aa-ba69-075949667a37.png)


过程：发送方的发送窗口是 3 个帧（这里举例实际中可以是其他个数），接收方接收窗口是 1 个帧。（这样的安排就可以确定是按 0、1、2、3 的顺序进行排列了，因为那个不等式得出 n 为 2）

发送方在发送了 3 个帧后，接收方进行接收，一个一个的接收，在最后一个帧接收完成后，返回一个 ACK2，表示这个帧以前的我都接收成功了，然后发送窗口向后滑动。这个是正常的情况，下面说一下不正常的情况。

**数据帧丢失：**以第二次发送窗口中的 E 丢失为例，D 在正确接收后，接收窗口到了 E，但是发送的 E 丢失了，接收窗口接收到了 F 对应的 1，但是现在是要接收 E 对应的 0，所以直接将不是想要的帧丢弃，并返回最后接收到帧 D 的 ACK3，然后发送窗口向后滑动，因为发送窗口中的 0 迟迟没有收到对应的 ACK， 由于超时重传机制，所以将其以及以后的滑动窗口中的所有帧进行再一次的发送。

**确认帧丢失：**发送方发送 A、B、C 后，接收方到 C 已经全部接收成功，所以返回一个 ACK2 并将滑动窗口向后移动一帧，但是这个确认帧在返回过程中丢失，那么 A 在超时后会将这个滑动窗口内的所有帧进行重传，显然是落不到接收方的滑动窗口中的，所以接收方直接丢弃并返回最近的一个成功接收帧的 ACK，也就是 ACK2，发送方在接收后知道了，从而将滑动窗口向后移动。



## 选择重传协议
![画板](https://cdn.nlark.com/yuque/0/2025/jpeg/48073730/1740189524253-3ffc4822-dfce-45f9-bb13-6eeff2f5eebb.jpeg)

在实际应用中发送窗口和接收窗口的大小通常是相同的。为什么 Wr<=Wt 呢？简单的来理解就是要保证接收方窗口的利用率高，如果接收方窗口大于发送方的话有些位置会长时间为空。

![](https://cdn.nlark.com/yuque/0/2025/png/48073730/1735908058508-5eae9a1b-05ef-4852-a42c-a987a93ce3d8.png)


过程：

发送方在发送一个发送窗口中的帧后，等待接收接收方返回的 ACKi 如果整个发送窗口中的第一个帧（下界）收到对应的 ACKi 就可以将发送窗口向后滑动，接收窗口在 ACKi 发送出去后就向后滑动了。

**数据帧丢失：**如果在发送方的 F（5 号帧） 在传输过程中丢失，那么接收窗口只会向后滑动一格，因为 F 没有收到，此时发送方只接收到了 ACK4，所以发送方的滑动窗口也只能向后滑动一格，发送方里新进入的 0 号帧会进行传输， 5 号帧会因为超时重传机制而重新传输，接收方在正确收到后返回对应的 ACKi 并将接收窗口向后滑动，发送方在接收到 ACKi 后滑动窗口也对应着向后滑动。**（在发送方发送了一个帧之后因为一些原因并没有到达接收方，那么接收方会先将这个帧之前和之后成功接收的帧的 ACKi 返回，接收窗口会向后滑动，发送方的发送窗口也会向后滑动（没有接收到 ACKi 的帧作为发送窗口的第一个帧），但是发送方丢失的帧并不会收到 ACKi，超时之后就会重传。）**

**数据帧因为差错而被丢失:**接收方在接收了一个帧之后经检查发现这个帧有差错，会将这个帧进行丢弃的同时返回一个 NAKi 表示这个帧出现问题，需要重新传输

**确认帧丢失：**意思就是接收窗口正常向后滑动了，但是发送窗口由于没有接收到对应帧的 ACKi，所以只能移动一部分，那些没有接收到 ACKi 的帧会重传，新进入的帧也会传输，接收方在接收到不是这个窗口的帧时（就是没有收到 ACKi 的帧）会直接认为是正确收到的返回对应的 ACKi



![](https://cdn.nlark.com/yuque/0/2025/png/48073730/1740215467520-e031cc0b-c561-4e25-8790-a4c4f14f5998.png)

## 三种协议的信道利用率
### 知识总览
![画板](https://cdn.nlark.com/yuque/0/2025/jpeg/48073730/1735998136909-d560b2c5-29c8-407e-97ce-448026c7a1c2.jpeg)

### S-W 协议信道利用率
![](https://cdn.nlark.com/yuque/0/2025/png/48073730/1735970667843-a007179c-97f8-4966-b912-e53cbbc6ac96.png)

因为确认 ACKi 传输时延很小所以在实际中都是不加入计算的。比较简单，利用画图进行理解

![](https://cdn.nlark.com/yuque/0/2025/png/48073730/1735970837950-e67c5c1f-e250-4b09-9399-1a0bdf5822f4.png)


答案：D

设数据的传输时延为 xms，因为传播时延为 200ms 所以 RTT 为 400ms，根据公式可以得出

![image](https://cdn.nlark.com/yuque/__latex/8d99ade9640588d4c4ec2909b277ff8b.svg)

这样可以解出传输时延，然后根据数据传输速率就可以算出数据帧为 800bit



### GBN、SR 协议信道利用率
![](https://cdn.nlark.com/yuque/0/2025/png/48073730/1735971341867-d2cc38f0-f146-42c5-9c4a-ae81130d291d.png)

根据图片非常好理解。如果在 ACKi 返回时发送方还在发送那么信道利用率为 1

![](https://cdn.nlark.com/yuque/0/2025/png/48073730/1735971604329-53dc5fe6-932e-4e46-a230-7f41cb1b39ed.png)


答案：C

这道题我觉得可以使用两种想法来解决，一种是计算信道利用率，然后乘以信道带宽。一种是直接使用数据量除以传输时间。

1、一个帧长为 1000B，信道带宽 1000Mbps，所以可以得出一个帧的传输时延为 0.8ms，然后有 1000 个帧

所以全部的传输需要 80ms，给出了一个单向传播时延为 50ms，所以两个 100ms>80ms，传输都是在传播里面完成的，计算的话就是 80/(100+0.8)=0.8，这里需要加上刚开始的一个 0.8ms 的传输时延。0.8*100=80Mbps

2、根据 1 的计算可以得出 1000B*1000/(100ms + 0.8ms) = 80Mbps



![](https://cdn.nlark.com/yuque/0/2025/png/48073730/1735997182515-cee824df-b05d-484c-9c31-222d4f55445d.png)


答案：B

**提到使用滑动窗口协议是指 GBN 或 SR 协议。**

这里进行说明：在理想情况下 GBN 和 SR 协议的信道利用率的方法是一样的

可以计算出一个帧的传输时延为 62.5ms，设发送窗口大小为 Wt 则根据公式 62.5xWt/500+62.5>=0.8

算出来 Wt>=7.2，设帧序号的比特数为 m，发送窗口和接收窗口需要满足 Wt+Wr<=2^m，GBN 的 Wr=1，所以此时 Wt+Wr=8.2 至少需要 4个比特数，SR 的 Wr>1，至少为 2，此时 Wt+Wr=9.2 至少需要 4 个比特数，所以 m 至少要为 4

