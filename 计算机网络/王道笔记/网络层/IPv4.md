# 各种协议之间的服务关系
![](https://cdn.nlark.com/yuque/0/2025/png/48073730/1738308290432-c7a33dee-161e-4656-a504-6881c095a22e.png)

ip 协议在整个网络中处于核心地位。ip 分组可以接受上层的 TCP、UDP 协议数据，同层的 ICMP、IGMP 协议也需要用到 ip 分组。ip 层又可以调用下层工作。

1. IP 协议：是互联网的核心
2. ARP 协议：用于查询同一网络中 ip 和 mac 地址之间的映射关系
3. ICMP 协议：用于网络层实体之间相互通知“异常事件”
4. IGMP 协议：用于实现 ip 组播

# ip 数据报的格式
![](https://cdn.nlark.com/yuque/0/2025/png/48073730/1738313478420-a3b903ad-5911-408a-ada9-29398005e8c0.png)

ip 分组是由首部和数据部分构成的。

在首部中有：固定部分（20B）和可变部分（0~40B）；在固定部分中首先是版本表示是使用 ipv4 还是 ipv6，然后是首部长度，这个表示出的数字要乘以 4 才是真正的首部长度字节，因为其只有 4bit，所以最多表示 15，所以首部长度最长为 4 x 15 = 60B，因此可变部分才是 0~40B（因为固定长度为 20B 嘛） ，这个首部检验和只是检验首部的，数据部分需要交给传输层进行检验，然后是可变部分的填充部分需要说明一下，这个填充是为了使得首部数据字节为 4 的倍数，这个是因为这个首部长度乘以 4 造成的印象。

**将 ip 数据报交给下层传输时，实际上会受到下一段链路的最短帧长和最长帧长的影响。**

# ip 数据报的分片问题
**<font style="color:#5C8D07;">重要概念：MTU：一个链路层数据帧能承载的最大数据量成为最大传送单元。如：以太网的 MTU 为 1500B  
</font>**如果一个 ip 数据报的总长度超过了下一个链路 MTU，就需要进行分片

![](https://cdn.nlark.com/yuque/0/2025/png/48073730/1738327153956-8b323f62-fa85-4cf1-8a11-109d1a765eff.png)

这个标识是标明这个分片是属于哪个 ip 数据报的，同一个 ip 数据报经过分片后的各个片的标识是一样的

然后标志从低位到高位分别是 MF、DF、无所谓。MF 为 1 就表示后面还有分片，为 0 后面就没有分片了；DF 表示这个 ip 数据报能不能进行分片，为 1 表示该 ip 数据报不能被分片，为 0 就表示可以被分片。

如果有个 ip 数据报的 DF 为 1，且下一个链路的 MTU 小于该 ip 数据报的话，路由器会将该 ip 数据报丢弃并返回一个 ICMP 报文表示异常情况

片偏移代表分片后数据开始的字节在源 ip 数据报中的字节位置，需要将其乘以 8

![](https://cdn.nlark.com/yuque/0/2025/png/48073730/1738327811170-5b93de5e-0c53-404f-8330-52031216ccbb.png)

这幅图详细地说明了 ip 数据报的分片过程。ip 数据报的分片不仅可以发生在源主机还可以发生在传输过程中的任意一个路由器中。

# ip 数据报的生存时间等
![](https://cdn.nlark.com/yuque/0/2025/png/48073730/1738328195186-9273f676-680c-439f-83b4-d9fd29259b57.png)

TTL：是 ip 数据报的存活时间，就是可以跑的路由器个数，如果为 0 还没有达到目的节点则丢弃并返回一个 ICMP 报文通知源主机出错了。

协议：这个字段表示该 ip 数据报是采用的什么协议是 TCP 协议吗还是 UDP 协议，这样目的节点接收后才知道交给哪一个协议进行处理。

首部校验和：这个只用校验 ip 数据报的首部，数据部分不用校验，也不是 ip 层的工作。



最后的源地址和目的地址都是 32bit

# IPv4 表示形式
点分十进制。如：255.255.13.43

